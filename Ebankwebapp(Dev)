pipeline {
    agent {
        label 'WebserverTestEnv3.4' // Ensure it runs on the Windows agent
    }

    environment {
        MSBUILD_PATH = "\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2022\\BuildTools\\MSBuild\\Current\\Bin\\msbuild.exe\""
        SOLUTION_PATH = "\"C:\\Jenkins\\workspace\\Ebankwebapp(Dev)\\src\\EbankCore.sln\""
        PUBLISH_PATH = "\"C:\\inetpub\\wwwroot\\EBankWebApp\"" // Target publish path
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'develop', credentialsId: 'azure', url: 'https://IfinixFintech@dev.azure.com/IfinixFintech/EbankChallenger/_git/EbankChallenger_AWS'
            }
        }

        stage('Restore NuGet Packages') {
            steps {
                bat """
                    %MSBUILD_PATH% %SOLUTION_PATH% /t:Restore
                """
            }
        }

        stage('Build') {
            steps {
                bat """
                    %MSBUILD_PATH% %SOLUTION_PATH% /t:Rebuild /p:Configuration=Release
                """
            }
        }

        stage('Publish') {
            steps {
                bat """
                    %MSBUILD_PATH% %SOLUTION_PATH% /t:Rebuild /p:Configuration=Release /p:OutputPath=%PUBLISH_PATH%
                """
            }
        }
    }
}
